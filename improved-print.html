<template id="improved-print-template">
  <slot name="content"></slot>
</template>

<script>
  class ImprovedPrint extends HTMLElement {
    constructor() {
      super();

      const templateId = 'improved-print-template';
      const printSpecificClass = 'improved-print__print-only';

      const currentDocument = document.currentScript.ownerDocument;
      const template = currentDocument.getElementById(templateId).content;

      this._printOnlyClass = printSpecificClass;

      this.shadow = this.attachShadow({mode: 'open'});
      this.shadow.appendChild(template.cloneNode(true));
      
      this._mql = window.matchMedia('print');
      this._boundPrintListener = this._onPrint.bind(this);
      
      this._addListeners();
    }
    
    /**
     * @private
     */
    _addListeners() {
      this._mql.addListener(this._boundPrintListener);
    }
    
    /**
     * On print handler.
     * @param {MediaQueryListEvent} event
     * @private
     */
    _onPrint(event) {
      const isAboutToPrint = event.matches;
      isAboutToPrint ? this._handleDOM() : this._removeDOM();
    }
    
    /**
     * Create and append the footnotes block.
     * Create and append additional <sup> elements to serve as
     *   notifiers within the original links.
     * @private
     */
    _handleDOM() {
      const links = this.links;
      
      if (!links) return;

      const container = document.createElement('div');
      const orderedList = document.createElement('ol');
      container.appendChild(orderedList);
      container.className = `a11y__container ${this._printOnlyClass}`;

      this.shadow.appendChild(container);

      for (let index = 0; index < links.length; index++) {
        const link = links[index];
        const listNumber = index + 1;
        const listItem = this._prepareFootnote(links[index]);

        link.appendChild(this._createSupElement(listNumber.toString()));
        orderedList.appendChild(listItem);
      }
    }
    
    /**
     * Get all the links encapsulated by the component.
     * @return {NodeList}
     * @private
     */
    get links() {
      return this.querySelectorAll('a[href]');
    }

    /**
     * Create a hyperlink and encapsulate it within an list item.
     * @param {HTMLElement} link
     * @private
     */
    _prepareFootnote(link) {
      const href = link.href;

      const listItem = document.createElement('li');
      const a = this._createLinkElement(href, href);

      listItem.appendChild(a);
      
      return listItem;
    }
    
    /**
     * @param {String} text
     * @param {String} href
     * @return {HTMLElement}
     * @private
     */
    _createLinkElement(text, href) {
      const element = document.createElement('a');
      const textNode = document.createTextNode(text);

      element.href = href;

      element.appendChild(textNode);

      return element;
    }
    
    /**
     * @param {String} text
     * @return {HTMLElement}
     * @private
     */
    _createSupElement(text) {
      const element = document.createElement('sup');
      const textNode = document.createTextNode(text);

      element.classList.add(this._printOnlyClass);

      element.appendChild(textNode);
      
      return element;
    }
    
    /**
     * Remove all the generated DOM by looping through classes.
     * @private
     */
    _removeDOM() {
      const selector = `.${this._printOnlyClass}`;
      const lightDOMElements = this.querySelectorAll(selector);
      const shadowDOMElements = this.shadow.querySelectorAll(selector);
      let elements = [...lightDOMElements, ...shadowDOMElements];
      
      for (let i = elements.length - 1; i >= 0; i--) {
        elements[i].remove();
        elements[i] = null;
      }
    }
    
    /**
     * Remove Event Listeners
     * @private
     */
    _removeEventListeners() {
      this._mql.removeListener(this._boundPrintListener);
    }

    disconnectedCallback() {
      this._removeDOM();
      this._removeEventListeners();

      this._mql = null;
      this._boundPrintListener = null;
      this.elements = null;
    }
  }

  // Define the new element
  window.customElements.define('improved-print', ImprovedPrint);
</script>
